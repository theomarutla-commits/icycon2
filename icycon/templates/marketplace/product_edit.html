{% extends "base.html" %}

{% block title %}Edit {{ product.title }} â€” Marketplace{% endblock %}

{% block breadcrumb %}/ Marketplace / <a href="{% url 'my-products' %}">My Products</a> / {{ product.title }} / Edit{% endblock %}

{% block head %}
<style>
  .form-section {
    background: var(--card-bg);
    padding: 24px;
    border-radius: 8px;
    margin-bottom: 24px;
  }
  .form-section h3 {
    margin-top: 0;
    margin-bottom: 20px;
    padding-bottom: 12px;
    border-bottom: 2px solid var(--primary);
  }
  .form-group {
    margin-bottom: 20px;
  }
  .form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
  }
  .form-group input,
  .form-group textarea,
  .form-group select {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 6px;
    box-sizing: border-box;
    font-size: 16px;
  }
  .form-group textarea {
    resize: vertical;
    min-height: 120px;
  }
  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
  }
  .button-group {
    display: flex;
    gap: 12px;
    margin-top: 30px;
  }
  .button-group button, .button-group a {
    flex: 1;
    padding: 12px 20px;
    font-size: 1em;
  }
</style>
{% endblock %}

{% block content %}

<h1>Edit Product: {{ product.title }}</h1>

<form method="post" id="productForm">
  {% csrf_token %}

  <!-- Basic Information -->
  <div class="form-section">
    <h3>Basic Information</h3>
    
    <div class="form-group">
      <label for="title">Product Title *</label>
      <input type="text" id="title" name="title" value="{{ product.title }}" required>
    </div>

    <div class="form-group">
      <label for="description">Description *</label>
      <textarea id="description" name="description" required>{{ product.description }}</textarea>
    </div>

    <div class="form-group">
      <label for="category">Category *</label>
      <select id="category" name="category" required>
        {% for value, label in categories %}
          <option value="{{ value }}" {% if product.category == value %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="form-group">
      <label for="featured_image">Featured Image URL</label>
      <input type="url" id="featured_image" name="featured_image" value="{{ product.featured_image }}">
    </div>
  </div>

  <!-- Pricing -->
  <div class="form-section">
    <h3>Pricing</h3>
    
    <div class="form-group">
      <label>Pricing Type *</label>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px;">
        <div>
          <input type="radio" id="pricing_free" name="pricing_type" value="free" {% if product.pricing_type == 'free' %}checked{% endif %}>
          <label for="pricing_free">Free</label>
        </div>
        <div>
          <input type="radio" id="pricing_fixed" name="pricing_type" value="fixed" {% if product.pricing_type == 'fixed' %}checked{% endif %}>
          <label for="pricing_fixed">Fixed Price</label>
        </div>
        <div>
          <input type="radio" id="pricing_sub" name="pricing_type" value="subscription" {% if product.pricing_type == 'subscription' %}checked{% endif %}>
          <label for="pricing_sub">Subscription</label>
        </div>
        <div>
          <input type="radio" id="pricing_custom" name="pricing_type" value="custom" {% if product.pricing_type == 'custom' %}checked{% endif %}>
          <label for="pricing_custom">Custom Quote</label>
        </div>
      </div>
    </div>

    <div id="fixed_pricing" class="dynamic-pricing">
      <div class="form-group">
        <label for="price">Price ($)</label>
        <input type="number" id="price" name="price" min="0" step="0.01" value="{{ product.price|default:'' }}">
      </div>
    </div>

    <div id="subscription_pricing" class="dynamic-pricing">
      <div class="form-row">
        <div class="form-group">
          <label for="subscription_price">Price ($)</label>
          <input type="number" id="subscription_price" name="subscription_price" min="0" step="0.01" value="{{ product.subscription_price|default:'' }}">
        </div>
        <div class="form-group">
          <label for="subscription_interval">Interval</label>
          <select id="subscription_interval" name="subscription_interval">
            <option value="monthly" {% if product.subscription_interval == 'monthly' %}selected{% endif %}>Monthly</option>
            <option value="yearly" {% if product.subscription_interval == 'yearly' %}selected{% endif %}>Yearly</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- Product Details -->
  <div class="form-section">
    <h3>Product Details</h3>
    
    <div class="form-group">
      <label for="features">Features (one per line)</label>
      <textarea id="features" name="features">{{ product.features|join:'&#10;' }}</textarea>
    </div>

    <div class="form-group">
      <label for="tags">Tags (comma-separated)</label>
      <input type="text" id="tags" name="tags" value="{{ product.tags|join:', ' }}">
    </div>

    <div class="form-row">
      <div class="form-group">
        <label for="available_quantity">Available Quantity</label>
        <input type="number" id="available_quantity" name="available_quantity" min="1" value="{{ product.available_quantity|default:'' }}">
      </div>

      <div class="form-group">
        <label>
          <input type="checkbox" name="is_limited_edition" {% if product.is_limited_edition %}checked{% endif %}>
          Limited Edition / Special Offer
        </label>
      </div>
    </div>
  </div>

  <!-- Submit Buttons -->
  <div class="button-group">
    <a href="{% url 'my-products' %}" class="button" style="background: var(--text-light); color: white;">Cancel</a>
    <button type="submit" class="button">Save Changes</button>
  </div>
</form>

<script>
  const pricingForm = document.getElementById('productForm');
  const pricingRadios = pricingForm.querySelectorAll('input[name="pricing_type"]');
  const fixedPricing = document.getElementById('fixed_pricing');
  const subscriptionPricing = document.getElementById('subscription_pricing');

  function updatePricingFields() {
    const selected = document.querySelector('input[name="pricing_type"]:checked').value;
    fixedPricing.style.display = 'none';
    subscriptionPricing.style.display = 'none';
    
    if (selected === 'fixed') {
      fixedPricing.style.display = 'block';
    } else if (selected === 'subscription') {
      subscriptionPricing.style.display = 'block';
    }
  }

  pricingRadios.forEach(radio => {
    radio.addEventListener('change', updatePricingFields);
  });

  // Initialize
  updatePricingFields();

  // Parse features and tags on submit
  pricingForm.addEventListener('submit', function(e) {
    const featuresText = document.getElementById('features').value;
    const features = featuresText.split('\n').filter(f => f.trim());
    
    const tagsText = document.getElementById('tags').value;
    const tags = tagsText.split(',').map(t => t.trim()).filter(t => t);
    
    // Store as hidden inputs
    const featuresInput = document.createElement('input');
    featuresInput.type = 'hidden';
    featuresInput.name = 'features';
    featuresInput.value = JSON.stringify(features);
    this.appendChild(featuresInput);
    
    const tagsInput = document.createElement('input');
    tagsInput.type = 'hidden';
    tagsInput.name = 'tags';
    tagsInput.value = JSON.stringify(tags);
    this.appendChild(tagsInput);
  });
</script>

{% endblock %}
