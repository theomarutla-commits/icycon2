{% extends "base.html" %}

{% block title %}{{ product.title }} ‚Äî Marketplace{% endblock %}

{% block breadcrumb %}/ Marketplace / <a href="{% url 'marketplace-home' %}">Home</a> / <a href="{% url 'product-list' %}">Products</a> / {{ product.title }}{% endblock %}

{% block head %}
<style>
  .product-header {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 40px;
    margin-bottom: 40px;
  }
  .product-image {
    width: 100%;
    aspect-ratio: 1;
    border-radius: 12px;
    overflow: hidden;
    background: var(--card-bg);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 5em;
  }
  .product-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  .product-info h1 {
    margin: 0 0 12px 0;
    font-size: 2em;
  }
  .product-rating {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 16px;
  }
  .stars {
    color: #ffa500;
    font-size: 1.2em;
  }
  .product-meta {
    color: var(--text-light);
    margin-bottom: 24px;
    padding-bottom: 24px;
    border-bottom: 1px solid #e0e0e0;
  }
  .product-price {
    font-size: 2.5em;
    font-weight: bold;
    color: var(--primary);
    margin-bottom: 24px;
  }
  .product-features {
    background: var(--card-bg);
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 24px;
  }
  .product-features h4 {
    margin: 0 0 12px 0;
  }
  .product-features ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  .product-features li {
    padding: 6px 0;
    color: var(--text-light);
  }
  .product-features li:before {
    content: "‚úì ";
    color: var(--primary);
    font-weight: bold;
  }
  .action-buttons {
    display: flex;
    gap: 12px;
    flex-direction: column;
  }
  .action-buttons button, .action-buttons a {
    padding: 12px 20px;
    font-size: 1em;
    width: 100%;
    text-align: center;
  }
  .seller-card {
    background: var(--card-bg);
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 40px;
  }
  .seller-card h3 {
    margin: 0 0 12px 0;
  }
  .reviews-section {
    margin-top: 40px;
  }
  .review-item {
    background: var(--card-bg);
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 16px;
  }
  .review-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 12px;
  }
  .review-rating {
    color: #ffa500;
    font-weight: bold;
  }
  .review-author {
    font-weight: bold;
    color: var(--text);
  }
  .rating-distribution {
    margin-bottom: 24px;
  }
  .rating-bar {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 8px;
  }
  .rating-bar-fill {
    height: 8px;
    background: #e0e0e0;
    border-radius: 4px;
    flex: 1;
    overflow: hidden;
  }
  .rating-bar-fill-inner {
    height: 100%;
    background: #ffa500;
  }
  @media (max-width: 768px) {
    .product-header {
      grid-template-columns: 1fr;
    }
  }
</style>
{% endblock %}

{% block content %}

<div class="product-header">
  <!-- Product Image -->
  <div class="product-image">
    {% if product.featured_image %}
      <img src="{{ product.featured_image }}" alt="{{ product.title }}">
    {% else %}
      üì¶
    {% endif %}
  </div>

  <!-- Product Info -->
  <div class="product-info">
    <h1>{{ product.title }}</h1>
    
    <div class="product-rating">
      <div class="stars">
        {% if product.avg_rating %}
          {% for i in "12345" %}
            {% if forloop.counter <= product.avg_rating %}‚òÖ{% else %}‚òÜ{% endif %}
          {% endfor %}
        {% else %}
          ‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ
        {% endif %}
      </div>
      <div>
        {% if product.avg_rating %}
          <strong>{{ product.avg_rating|floatformat:1 }}</strong> 
          <span style="color: var(--text-light);">({{ product.review_count }} reviews)</span>
        {% else %}
          <span style="color: var(--text-light);">No reviews yet</span>
        {% endif %}
      </div>
    </div>
    
    <div class="product-meta">
      <p><strong>Seller:</strong> {{ product.tenant.name }}</p>
      <p><strong>Category:</strong> {{ product.get_category_display }}</p>
      <p><strong>Posted:</strong> {{ product.published_at|date:"M d, Y" }}</p>
      {% if product.is_limited_edition and product.available_quantity %}
        <p style="color: #ff6b6b;"><strong>‚ö†Ô∏è Limited Edition:</strong> Only {{ product.available_quantity }} left</p>
      {% endif %}
    </div>
    
    <div class="product-price">
      {% if product.pricing_type == 'free' %}
        <span style="color: var(--primary);">Free</span>
      {% elif product.pricing_type == 'fixed' %}
        ${{ product.price }}
      {% elif product.pricing_type == 'subscription' %}
        ${{ product.subscription_price }}/{{ product.subscription_interval }}
      {% else %}
        <span style="color: var(--text-light);">Custom Quote</span>
      {% endif %}
    </div>
    
    {% if product.features %}
      <div class="product-features">
        <h4>Features</h4>
        <ul>
          {% for feature in product.features %}
            <li>{{ feature }}</li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}

    <div class="action-buttons">
      {% if user.is_authenticated %}
        <a href="{% url 'order-create' product.id %}" class="button" style="background: var(--primary); color: white;">
          {% if product.pricing_type == 'free' %}Get Access{% else %}Buy Now{% endif %}
        </a>
        <a href="{% url 'conversation-start' product.id %}" class="button" style="background: var(--secondary); color: white;">
          Ask a Question
        </a>
        <form method="post" style="display: inline; width: 100%;">
          {% csrf_token %}
          {% if is_saved %}
            <a href="{% url 'unsave-product' product.id %}" class="button" style="background: #ff6b6b; color: white; display: block;">
              ‚úì Saved
            </a>
          {% else %}
            <button type="submit" formaction="{% url 'save-product' product.id %}" class="button" style="background: #6c757d; color: white;">
              Save for Later
            </button>
          {% endif %}
        </form>
      {% else %}
        <a href="{% url 'login' %}" class="button">Login to Purchase</a>
        <a href="{% url 'signup' %}" class="button">Create an Account</a>
      {% endif %}
    </div>
  </div>
</div>

<!-- Seller Information -->
<div class="seller-card">
  <h3>About the Seller</h3>
  <p><strong>{{ product.tenant.name }}</strong></p>
  <p style="color: var(--text-light);">
    Member since {{ product.tenant.created_at|date:"M Y" }}
  </p>
  {% if user.is_authenticated and product.tenant != user.tenantuser_set.first.tenant %}
    <a href="{% url 'conversation-start' product.id %}" class="button">Contact Seller</a>
  {% endif %}
</div>

<!-- Product Description -->
<div style="background: var(--card-bg); padding: 24px; border-radius: 8px; margin-bottom: 40px;">
  <h3>Description</h3>
  <p>{{ product.description|linebreaks }}</p>
  
  {% if product.tags %}
    <div style="margin-top: 16px;">
      <strong>Tags:</strong>
      {% for tag in product.tags %}
        <span style="display: inline-block; background: var(--primary); color: white; padding: 4px 12px; border-radius: 16px; margin: 4px 4px 4px 0; font-size: 0.9em;">
          {{ tag }}
        </span>
      {% endfor %}
    </div>
  {% endif %}
</div>

<!-- Reviews Section -->
<div class="reviews-section">
  <h2>Customer Reviews</h2>
  
  {% if product.review_count > 0 %}
    <!-- Rating Distribution -->
    <div class="rating-distribution">
      <h4>Rating Distribution</h4>
      {% for rating, count in rating_distribution.items reversed %}
        <div class="rating-bar">
          <span style="width: 30px;">{{ rating }}‚òÖ</span>
          <div class="rating-bar-fill">
            <div class="rating-bar-fill-inner" style="width: {{ count|multiply:100|divide:product.review_count }}%"></div>
          </div>
          <span style="width: 40px; text-align: right;">{{ count }}</span>
        </div>
      {% endfor %}
    </div>

    <!-- Reviews List -->
    {% for review in reviews %}
      <div class="review-item">
        <div class="review-header">
          <div>
            <div class="review-author">{{ review.reviewer.get_full_name|default:review.reviewer.username }}</div>
            <div style="font-size: 0.9em; color: var(--text-light);">{{ review.created_at|date:"M d, Y" }}</div>
          </div>
          <div class="review-rating">
            {% for i in "12345" %}
              {% if forloop.counter <= review.rating %}‚òÖ{% else %}‚òÜ{% endif %}
            {% endfor %}
          </div>
        </div>
        <h4 style="margin: 8px 0;">{{ review.title }}</h4>
        <p style="margin: 0; color: var(--text-light);">{{ review.comment }}</p>
      </div>
    {% endfor %}
  {% else %}
    <div style="text-align: center; padding: 40px; background: var(--card-bg); border-radius: 8px;">
      <p style="color: var(--text-light);">No reviews yet. Be the first to review this product!</p>
    </div>
  {% endif %}

  <!-- Add Review Button -->
  {% if user.is_authenticated %}
    <div style="margin-top: 24px;">
      <a href="{% url 'review-create' product.id %}" class="button">
        Write a Review
      </a>
    </div>
  {% endif %}
</div>

{% endblock %}
