{% extends "base.html" %}

{% block title %}Browse Products â€” Marketplace{% endblock %}

{% block breadcrumb %}/ Marketplace / <a href="{% url 'marketplace-home' %}">Home</a> / Products{% endblock %}

{% block head %}
<style>
  .filter-sidebar {
    background: var(--card-bg);
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
  }
  .filter-section {
    margin-bottom: 20px;
    padding-bottom: 20px;
    border-bottom: 1px solid #e0e0e0;
  }
  .filter-section:last-child {
    border-bottom: none;
  }
  .filter-section h4 {
    margin: 0 0 12px 0;
    color: var(--text);
  }
  .filter-option {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
  }
  .filter-option input {
    margin-right: 8px;
    width: auto;
  }
  .filter-option label {
    margin: 0;
    cursor: pointer;
  }
  .products-container {
    display: grid;
    grid-template-columns: 1fr;
    gap: 20px;
  }
  .product-row {
    display: flex;
    gap: 20px;
    padding: 16px;
    background: var(--card-bg);
    border-radius: 8px;
    transition: all 0.2s;
  }
  .product-row:hover {
    box-shadow: 0 4px 12px var(--shadow);
    transform: translateY(-2px);
  }
  .product-row-image {
    width: 150px;
    height: 150px;
    flex-shrink: 0;
    border-radius: 6px;
    overflow: hidden;
    background: var(--bg);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-light);
    font-size: 2em;
  }
  .product-row-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  .product-row-content {
    flex: 1;
  }
  .product-row-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 12px;
  }
  .product-row-title {
    font-size: 1.2em;
    font-weight: bold;
    margin: 0;
    color: var(--primary);
  }
  .product-row-price {
    font-size: 1.3em;
    font-weight: bold;
    color: var(--primary);
  }
  .product-row-seller {
    color: var(--text-light);
    font-size: 0.9em;
    margin-bottom: 8px;
  }
  .product-row-description {
    color: var(--text-light);
    margin-bottom: 12px;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  .product-row-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .controls {
    display: flex;
    gap: 12px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }
  .controls input {
    flex: 1;
    min-width: 200px;
  }
  .controls select {
    min-width: 150px;
  }
  @media (max-width: 768px) {
    .product-row {
      flex-direction: column;
    }
    .product-row-image {
      width: 100%;
      height: 200px;
    }
  }
</style>
{% endblock %}

{% block content %}

<div style="display: flex; gap: 20px;">
  <!-- Filters Sidebar -->
  <aside style="flex: 0 0 250px;">
    <form method="get" class="filter-sidebar">
      <!-- Search -->
      <div class="filter-section">
        <h4>Search</h4>
        <input type="text" name="q" value="{{ query }}" placeholder="Search products..." style="width: 100%; padding: 8px; box-sizing: border-box;">
      </div>

      <!-- Category Filter -->
      <div class="filter-section">
        <h4>Category</h4>
        {% for value, label in categories %}
          <div class="filter-option">
            <input type="radio" name="category" value="{{ value }}" id="cat_{{ value }}" {% if category == value %}checked{% endif %}>
            <label for="cat_{{ value }}">{{ label }}</label>
          </div>
        {% endfor %}
        <div class="filter-option">
          <input type="radio" name="category" value="" id="cat_all" {% if not category %}checked{% endif %}>
          <label for="cat_all">All Categories</label>
        </div>
      </div>

      <!-- Price Filter -->
      <div class="filter-section">
        <h4>Price</h4>
        <div class="filter-option">
          <input type="radio" name="price_range" value="free" id="price_free" {% if price_range == 'free' %}checked{% endif %}>
          <label for="price_free">Free</label>
        </div>
        <div class="filter-option">
          <input type="radio" name="price_range" value="under_50" id="price_50" {% if price_range == 'under_50' %}checked{% endif %}>
          <label for="price_50">Under $50</label>
        </div>
        <div class="filter-option">
          <input type="radio" name="price_range" value="50_200" id="price_50_200" {% if price_range == '50_200' %}checked{% endif %}>
          <label for="price_50_200">$50 - $200</label>
        </div>
        <div class="filter-option">
          <input type="radio" name="price_range" value="over_200" id="price_200" {% if price_range == 'over_200' %}checked{% endif %}>
          <label for="price_200">Over $200</label>
        </div>
        <div class="filter-option">
          <input type="radio" name="price_range" value="" id="price_all" {% if not price_range %}checked{% endif %}>
          <label for="price_all">All Prices</label>
        </div>
      </div>

      <!-- Sort -->
      <div class="filter-section">
        <h4>Sort By</h4>
        <select name="sort" style="width: 100%;">
          <option value="-published_at" {% if sort == '-published_at' %}selected{% endif %}>Newest First</option>
          <option value="title" {% if sort == 'title' %}selected{% endif %}>Name: A-Z</option>
          <option value="-rating" {% if sort == '-rating' %}selected{% endif %}>Highest Rated</option>
          <option value="price" {% if sort == 'price' %}selected{% endif %}>Price: Low to High</option>
          <option value="-price" {% if sort == '-price' %}selected{% endif %}>Price: High to Low</option>
        </select>
      </div>

      <button type="submit" class="button" style="width: 100%;">Apply Filters</button>
    </form>
  </aside>

  <!-- Products Section -->
  <main style="flex: 1;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h1>Browse Products</h1>
      <div style="text-align: right; color: var(--text-light);">
        Showing {{ products|length }} product{{ products|length|pluralize }}
      </div>
    </div>

    {% if products %}
      <div class="products-container">
        {% for product in products %}
          <a href="{% url 'product-detail' product.id %}" style="text-decoration: none; color: inherit;">
            <div class="product-row">
              <div class="product-row-image">
                {% if product.featured_image %}
                  <img src="{{ product.featured_image }}" alt="{{ product.title }}">
                {% else %}
                  ðŸ“¦
                {% endif %}
              </div>
              <div class="product-row-content">
                <div class="product-row-header">
                  <h2 class="product-row-title">{{ product.title }}</h2>
                  <div class="product-row-price">
                    {% if product.pricing_type == 'free' %}
                      Free
                    {% elif product.pricing_type == 'fixed' %}
                      ${{ product.price }}
                    {% elif product.pricing_type == 'subscription' %}
                      ${{ product.subscription_price }}/{{ product.subscription_interval }}
                    {% else %}
                      Custom
                    {% endif %}
                  </div>
                </div>
                
                <div class="product-row-seller">
                  by <strong>{{ product.tenant.name }}</strong>
                </div>
                
                <div class="product-row-description">
                  {{ product.description }}
                </div>
                
                <div class="product-row-footer">
                  <div>
                    {% if product.avg_rating %}
                      <span style="color: #ffa500;">â˜…</span>
                      <strong>{{ product.avg_rating|floatformat:1 }}</strong>
                      <span style="color: var(--text-light);">({{ product.review_count }} reviews)</span>
                    {% else %}
                      <span style="color: var(--text-light);">No reviews yet</span>
                    {% endif %}
                  </div>
                  
                  <div style="display: flex; gap: 8px;">
                    <span style="padding: 4px 8px; background: var(--primary); color: white; border-radius: 4px; font-size: 0.85em;">
                      {{ product.get_category_display }}
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </a>
        {% endfor %}
      </div>
    {% else %}
      <div style="text-align: center; padding: 40px; background: var(--card-bg); border-radius: 8px;">
        <p style="font-size: 1.2em; color: var(--text-light);">No products found matching your criteria.</p>
        <a href="{% url 'product-list' %}" class="button" style="display: inline-block; margin-top: 16px;">Clear Filters</a>
      </div>
    {% endif %}
  </main>
</div>

{% endblock %}
