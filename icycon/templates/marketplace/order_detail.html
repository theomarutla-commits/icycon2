{% extends "base.html" %}

{% block title %}Order ‚Äî Marketplace{% endblock %}

{% block breadcrumb %}/ Marketplace / <a href="{% url 'marketplace-home' %}">Home</a> / Order {{ order.order_number }}{% endblock %}

{% block head %}
<style>
  .order-header {
    background: var(--primary);
    color: white;
    padding: 24px;
    border-radius: 8px;
    margin-bottom: 24px;
  }
  .order-info {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
  }
  .info-block {
    background: var(--card-bg);
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
  }
  .info-block h3 {
    margin: 0 0 12px 0;
    color: var(--primary);
    font-size: 1em;
  }
  .info-block p {
    margin: 0;
    color: var(--text-light);
  }
  .timeline {
    margin: 20px 0;
  }
  .timeline-item {
    display: flex;
    gap: 16px;
    margin-bottom: 20px;
    padding-bottom: 20px;
    border-bottom: 1px solid #e0e0e0;
  }
  .timeline-item:last-child {
    border-bottom: none;
  }
  .timeline-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--primary);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    font-size: 1.2em;
  }
  .timeline-content h4 {
    margin: 0 0 4px 0;
  }
  .timeline-content p {
    margin: 0;
    color: var(--text-light);
    font-size: 0.9em;
  }
  .status-badge {
    display: inline-block;
    padding: 6px 16px;
    border-radius: 20px;
    font-weight: 500;
    font-size: 0.9em;
  }
  .status-pending {
    background: #fef3c7;
    color: #92400e;
  }
  .status-completed {
    background: #d1fae5;
    color: #065f46;
  }
  .status-cancelled {
    background: #fee2e2;
    color: #7f1d1d;
  }
</style>
{% endblock %}

{% block content %}

<div class="order-header">
  <h1 style="margin: 0 0 16px 0;">Order {{ order.order_number }}</h1>
  <span class="status-badge status-{{ order.status }}">{{ order.get_status_display }}</span>
</div>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 40px;">
  <!-- Product Info -->
  <div class="info-block">
    <h3>Product</h3>
    <p><strong><a href="{% url 'product-detail' order.product.id %}" style="color: var(--primary);">{{ order.product.title }}</a></strong></p>
    <p style="margin-top: 8px;">by {{ order.product.tenant.name }}</p>
  </div>

  <!-- Order Details -->
  <div class="info-block">
    <h3>Order Details</h3>
    <p><strong>Order Date:</strong> {{ order.created_at|date:"M d, Y H:i" }}</p>
    <p><strong>Quantity:</strong> {{ order.quantity }}</p>
    <p style="margin-top: 8px;"><strong>Unit Price:</strong> ${{ order.unit_price }}</p>
  </div>

  <!-- Pricing -->
  <div class="info-block">
    <h3>Pricing</h3>
    <p style="display: flex; justify-content: space-between; margin-bottom: 8px;">
      <span>Subtotal:</span>
      <span>${{ order.total_price }}</span>
    </p>
    <p style="display: flex; justify-content: space-between; margin-bottom: 8px;">
      <span>Tax:</span>
      <span>$0.00</span>
    </p>
    <p style="display: flex; justify-content: space-between; margin-bottom: 0; font-weight: bold; font-size: 1.1em; padding-top: 8px; border-top: 1px solid #ddd;">
      <span>Total:</span>
      <span>${{ order.total_price }}</span>
    </p>
  </div>

  <!-- Payment Status -->
  <div class="info-block">
    <h3>Payment</h3>
    <p><strong>Status:</strong> 
      <span class="status-badge status-{{ order.payment_status }}">{{ order.get_payment_status_display }}</span>
    </p>
    {% if order.payment_method %}
      <p style="margin-top: 8px;"><strong>Method:</strong> {{ order.payment_method }}</p>
    {% endif %}
  </div>
</div>

<!-- Buyer/Seller Info -->
{% if is_buyer %}
  <div class="info-block">
    <h3>üìç Your Information</h3>
    <p><strong>Name:</strong> {{ request.user.get_full_name|default:request.user.username }}</p>
    <p><strong>Email:</strong> {{ request.user.email }}</p>
    <p><strong>Organization:</strong> {{ request.user.tenantuser_set.first.tenant.name }}</p>
  </div>
{% endif %}

{% if is_seller %}
  <div class="info-block">
    <h3>üë§ Buyer Information</h3>
    <p><strong>Organization:</strong> {{ order.buyer_tenant.name }}</p>
    <p><strong>Email:</strong> {{ order.customer_email }}</p>
    {% if order.customer_message %}
      <p style="margin-top: 12px;"><strong>Buyer's Message:</strong></p>
      <p style="padding: 8px; background: var(--bg); border-radius: 4px; margin-top: 4px;">{{ order.customer_message }}</p>
    {% endif %}
  </div>
{% endif %}

<!-- Status Timeline -->
<div class="info-block">
  <h3>Order Timeline</h3>
  <div class="timeline">
    <div class="timeline-item">
      <div class="timeline-icon">üìã</div>
      <div class="timeline-content">
        <h4>Order Placed</h4>
        <p>{{ order.created_at|date:"M d, Y H:i" }}</p>
      </div>
    </div>
    
    {% if order.status == 'confirmed' %}
      <div class="timeline-item">
        <div class="timeline-icon">‚úì</div>
        <div class="timeline-content">
          <h4>Order Confirmed</h4>
          <p>{{ order.updated_at|date:"M d, Y H:i" }}</p>
        </div>
      </div>
    {% endif %}
    
    {% if order.status in 'processing,completed' %}
      <div class="timeline-item">
        <div class="timeline-icon">‚öôÔ∏è</div>
        <div class="timeline-content">
          <h4>Processing</h4>
          <p>{{ order.updated_at|date:"M d, Y H:i" }}</p>
        </div>
      </div>
    {% endif %}
    
    {% if order.status == 'completed' %}
      <div class="timeline-item">
        <div class="timeline-icon">‚úì</div>
        <div class="timeline-content">
          <h4>Completed</h4>
          <p>{{ order.completed_at|date:"M d, Y H:i" }}</p>
        </div>
      </div>
    {% endif %}
    
    {% if order.status == 'cancelled' %}
      <div class="timeline-item">
        <div class="timeline-icon">‚úó</div>
        <div class="timeline-content">
          <h4>Cancelled</h4>
          <p>{{ order.updated_at|date:"M d, Y H:i" }}</p>
        </div>
      </div>
    {% endif %}
  </div>
</div>

<!-- Actions -->
<div style="display: flex; gap: 12px; margin-top: 24px;">
  {% if is_buyer %}
    <a href="{% url 'my-orders' %}" class="button">Back to Orders</a>
    {% if order.product.pricing_type == 'free' %}
      <a href="{% url 'product-detail' order.product.id %}" class="button" style="background: var(--primary); color: white;">Access Product</a>
    {% endif %}
  {% elif is_seller %}
    <a href="{% url 'sales-dashboard' %}" class="button">Sales Dashboard</a>
    {% if order.status == 'pending' %}
      <button class="button" style="background: #10b981; color: white;">Confirm Order</button>
    {% endif %}
  {% endif %}
</div>

{% endblock %}
