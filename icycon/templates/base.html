{% load static %}
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>{% block title %}Icycon{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/boxicons@2.0.7/css/boxicons.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'chatbot/chat.css' %}">
    {% block extra_css %}{% endblock %}
    <style>
      :root {
        --primary: #0ea5e9;
        --primary-dark: #0284c7;
        --secondary: #7c3aed;
        --bg: #f7f9fc;
        --text: #222;
        --text-light: #666;
        --card-bg: #f1f5f9;
        --shadow: rgba(20,20,40,0.04);
        --nav-height: 64px;
      }
      body { 
        font-family: system-ui, -apple-system, Arial, sans-serif; 
        margin: 0; 
        padding: 0; 
        background: var(--bg); 
        color: var(--text);
        line-height: 1.5;
      }
      header { 
        background: linear-gradient(90deg, var(--primary), var(--secondary)); 
        color: white; 
        padding: 16px;
        position: sticky;
        top: 0;
        z-index: 10;
        box-shadow: 0 2px 8px var(--shadow);
      }
      .container { 
        max-width: 1000px; 
        margin: 24px auto; 
        padding: 24px; 
        background: white; 
        border-radius: 12px; 
        box-shadow: 0 2px 12px var(--shadow)
      }
      nav a { 
        color: rgba(255,255,255,0.95); 
        margin-right: 20px; 
        text-decoration: none;
        font-weight: 500;
        transition: color 0.2s;
      }
      nav a:hover {
        color: white;
      }
      .grid { 
        display: grid; 
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
        gap: 20px;
        margin: 24px 0;
      }
      .card { 
        padding: 20px; 
        border-radius: 8px; 
        background: var(--card-bg);
        transition: transform 0.2s, box-shadow 0.2s;
      }
      .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px var(--shadow);
      }
      label { 
        display: block; 
        margin-top: 12px;
        font-weight: 500;
        color: var(--text);
      }
      input, select { 
        width: 100%; 
        padding: 10px; 
        margin-top: 4px; 
        box-sizing: border-box;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 16px;
      }
      input:focus, select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(14,165,233,0.1);
      }
      button { 
        background: var(--primary); 
        color: white; 
        border: none; 
        padding: 12px 20px; 
        border-radius: 6px; 
        cursor: pointer;
        font-size: 16px;
        font-weight: 500;
        transition: background-color 0.2s;
      }
      button:hover {
        background: var(--primary-dark);
      }
      button:active {
        transform: translateY(1px);
      }
      footer { 
        text-align: center; 
        padding: 24px; 
        color: var(--text-light);
        font-size: 14px;
      }
      .logo {
        font-weight: 700;
        font-size: 24px;
        background: linear-gradient(90deg, white, rgba(255,255,255,0.9));
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      .breadcrumb {
        color: var(--text-light);
        font-size: 14px;
        margin-bottom: 16px;
      }
      .breadcrumb a {
        color: var(--primary);
        text-decoration: none;
      }
      .breadcrumb a:hover {
        text-decoration: underline;
      }

      /* Navigation Styles */
      header {
        position: fixed;
        width: 100%;
        height: var(--nav-height);
      }
      main {
        margin-top: calc(var(--nav-height) + 24px);
      }
      .main-nav {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .nav-section {
        position: relative;
        display: flex;
        align-items: center;
        gap: 4px;
      }
      .nav-label {
        font-size: 11px;
        font-weight: 600;
        color: rgba(255,255,255,0.6);
        padding: 3px 6px;
        border-radius: 4px;
        background: rgba(255,255,255,0.1);
      }
      .nav-section a, .dropdown-toggle {
        display: flex;
        align-items: center;
        gap: 4px;
        padding: 6px 10px;
        border-radius: 6px;
        transition: background-color 0.2s;
        font-size: 14px;
      }
      .nav-section a:hover, .dropdown-toggle:hover {
        background: rgba(255,255,255,0.1);
      }
      .dropdown {
        position: relative;
      }
      .dropdown-toggle {
        background: none;
        border: none;
        color: rgba(255,255,255,0.95);
        cursor: pointer;
        padding: 6px 10px;
        white-space: nowrap;
      }
      .dropdown-toggle i {
        font-size: 16px;
      }
      .dropdown-menu {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        min-width: 260px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 16px var(--shadow);
        padding: 12px 0;
        z-index: 100;
      }
      .dropdown-menu a {
        color: var(--text);
        padding: 8px 16px;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.95em;
        transition: all 0.2s ease;
      }
      .dropdown-menu a i {
        width: 20px;
        text-align: center;
      }
      .dropdown-menu a:hover {
        background: var(--bg);
        transform: translateX(4px);
      }
      .dropdown:hover .dropdown-menu {
        display: block;
      }
      .dropdown-divider {
        height: 1px;
        background: var(--bg);
        margin: 8px 0;
      }
      .dropdown-label {
        display: block;
        padding: 8px 16px 4px;
        color: var(--text-light);
        font-size: 0.8em;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }
      .dropdown-toggle {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 8px 12px;
        border-radius: 6px;
        color: rgba(255,255,255,0.95);
        font-size: inherit;
        cursor: pointer;
        background: none;
        border: none;
      }
      .dropdown-toggle i:last-child {
        font-size: 1.2em;
        margin-left: 2px;
      }
      .dropdown-toggle:hover {
        background: rgba(255,255,255,0.1);
      }
      .nav-user {
        margin-left: auto;
      }
      .user-toggle {
        font-weight: 600;
      }
      .nav-auth-buttons {
        display: flex;
        gap: 12px;
      }
      .nav-button {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 8px 16px;
        border-radius: 6px;
        font-weight: 500;
        transition: all 0.2s;
      }
      .login-button {
        background: rgba(255,255,255,0.1);
      }
      .login-button:hover {
        background: rgba(255,255,255,0.2);
      }
      .signup-button {
        background: white;
        color: var(--primary) !important;
      }
      .signup-button:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      }
      .mobile-menu-toggle {
        display: none;
        background: none;
        border: none;
        color: white;
        font-size: 24px;
        cursor: pointer;
        padding: 4px;
      }

      /* Responsive Styles */
      @media (max-width: 1200px) {
        .nav-label {
          display: none;
        }
      }

      @media (max-width: 992px) {
        .container {
          margin: 12px;
          padding: 16px;
        }
        .grid {
          grid-template-columns: 1fr;
        }
        .mobile-menu-toggle {
          display: block;
        }
        .main-nav {
          display: none;
          position: fixed;
          top: var(--nav-height);
          left: 0;
          right: 0;
          background: var(--primary);
          padding: 16px;
          flex-direction: column;
          align-items: stretch;
          gap: 12px;
          box-shadow: 0 4px 12px var(--shadow);
        }
        .main-nav.active {
          display: flex;
        }
        .nav-section {
          flex-direction: column;
          align-items: stretch;
        }
        .dropdown-menu {
          position: static;
          background: rgba(255,255,255,0.05);
          box-shadow: none;
        }
        .dropdown-menu a {
          color: white;
        }
        .nav-user {
          margin: 0;
          padding-top: 12px;
          border-top: 1px solid rgba(255,255,255,0.1);
        }
      }
    </style>
    {% block head %}{% endblock %}
    {% csrf_token %}
  </head>
  <body>
    <header>
      <div style="max-width:1100px;margin:0 auto;display:flex;align-items:center;justify-content:space-between">
        <div style="display:flex;align-items:center;gap:24px">
          <a href="/" class="logo" style="text-decoration:none">Icycon</a>
          <button class="mobile-menu-toggle" aria-label="Toggle Menu">
            <i class='bx bx-menu'></i>
          </button>
        </div>
        
        <nav class="main-nav">
          <div class="nav-section">
            <span class="nav-label">Core</span>
            <div class="dropdown">
              <button class="dropdown-toggle">
                <i class='bx bxs-dashboard'></i> Core
                <i class='bx bx-chevron-down'></i>
              </button>
              <div class="dropdown-menu">
                <a href="/"><i class='bx bxs-dashboard'></i> Home</a>
                <a href="/users/"><i class='bx bx-user'></i> User Dashboard</a>
              </div>
            </div>
          </div>

          <div class="nav-section">
            <span class="nav-label">Analytics & SEO</span>
            <div class="dropdown">
              <button class="dropdown-toggle">
                <i class='bx bx-line-chart'></i> Analytics
                <i class='bx bx-chevron-down'></i>
              </button>
              <div class="dropdown-menu">
                <a href="/analytics/"><i class='bx bx-line-chart'></i> Analytics Dashboard</a>
                <div class="dropdown-divider"></div>
                <span class="dropdown-label">Sites & Content</span>
                <a href="/analytics/sites/"><i class='bx bx-globe'></i> Manage Sites</a>
                <a href="/analytics/sites/create/"><i class='bx bx-plus'></i> Add Site</a>
                <div class="dropdown-divider"></div>
                <span class="dropdown-label">Analytics Tools</span>
                <a href="/analytics/keyword-clusters/"><i class='bx bx-key'></i> Keywords</a>
                <a href="/analytics/content-items/"><i class='bx bx-file'></i> Content Items</a>
                <a href="/analytics/faqs/"><i class='bx bx-help-circle'></i> FAQs</a>
              </div>
            </div>

            <div class="dropdown">
              <button class="dropdown-toggle">
                <i class='bx bx-search'></i> SEO
                <i class='bx bx-chevron-down'></i>
              </button>
              <div class="dropdown-menu">
                <a href="/seo/ui/"><i class='bx bx-search'></i> SEO Dashboard</a>
                <div class="dropdown-divider"></div>
                <span class="dropdown-label">Content Management</span>
                <a href="/seo/sites/"><i class='bx bx-globe'></i> Manage Sites</a>
                <a href="/seo/sites/create/"><i class='bx bx-plus'></i> Add Site</a>
                <div class="dropdown-divider"></div>
                <span class="dropdown-label">SEO Tools</span>
                <a href="/seo/keywords/"><i class='bx bx-key'></i> Keyword Clusters</a>
                <a href="/seo/content-items/"><i class='bx bx-file'></i> Content Items</a>
                <a href="/seo/faqs/"><i class='bx bx-help-circle'></i> FAQs</a>
              </div>
            </div>

          </div>

          <div class="nav-section">
            <span class="nav-label">Growth & Backlinks</span>
            <div class="dropdown">
              <button class="dropdown-toggle">
                <i class='bx bx-mobile-alt'></i> ASO
                <i class='bx bx-chevron-down'></i>
              </button>
              <div class="dropdown-menu">
                <a href="/aso/"><i class='bx bx-mobile-alt'></i> ASO Dashboard</a>
                <div class="dropdown-divider"></div>
                <span class="dropdown-label">App Optimization</span>
                <a href="/aso/app-management/"><i class='bx bx-mobile'></i> App Management</a>
                <a href="/aso/keyword-research/"><i class='bx bx-key'></i> Keyword Research</a>
              </div>
            </div>

            <div class="dropdown">
              <button class="dropdown-toggle">
                <i class='bx bx-link'></i> Backlinks
                <i class='bx bx-chevron-down'></i>
              </button>
              <div class="dropdown-menu">
                <a href="/seo/backlinks/"><i class='bx bx-link'></i> Backlinks Dashboard</a>
                <div class="dropdown-divider"></div>
                <span class="dropdown-label">Link Management</span>
                <a href="/seo/backlinks/analysis/"><i class='bx bx-globe'></i> Analysis</a>
                <a href="/seo/backlinks/competitors/"><i class='bx bx-bar-chart'></i> Competitors</a>
                <a href="/seo/backlinks/outreach/"><i class='bx bx-mail-send'></i> Outreach</a>
              </div>
            </div>

          </div>
          
          <div class="nav-section">
            <span class="nav-label">Content & Commerce</span>
            <div class="dropdown">
              <button class="dropdown-toggle">
                <i class='bx bx-share-alt'></i> Content & Channels
                <i class='bx bx-chevron-down'></i>
              </button>
              <div class="dropdown-menu">
                <a href="/social-media/posts/"><i class='bx bx-share-alt'></i> Posts & Content</a>
                <div class="dropdown-divider"></div>
                <span class="dropdown-label">Organization Promotion</span>
                <a href="/social-media/channels/"><i class='bx bx-broadcast'></i> Social Channels</a>
                <a href="/social-media/conversations/"><i class='bx bx-message-square-detail'></i> Conversations</a>
                <div class="dropdown-divider"></div>
                <span class="dropdown-label">Create</span>
                <a href="/social-media/posts/create/"><i class='bx bx-book-content'></i> New Post</a>
              </div>
            </div>

            <div class="dropdown">
              <button class="dropdown-toggle">
                <i class='bx bx-store'></i> Marketplace
                <i class='bx bx-chevron-down'></i>
              </button>
              <div class="dropdown-menu">
                <a href="/marketplace/"><i class='bx bx-store'></i> Marketplace Home</a>
                <div class="dropdown-divider"></div>
                <span class="dropdown-label">Shopping</span>
                <a href="/marketplace/products/"><i class='bx bx-package'></i> Browse Products</a>
                <a href="/marketplace/saved-products/"><i class='bx bx-heart'></i> Saved Products</a>
                <a href="/marketplace/my-orders/"><i class='bx bx-receipt'></i> My Orders</a>
                <div class="dropdown-divider"></div>
                <span class="dropdown-label">Selling</span>
                <a href="/marketplace/my-products/"><i class='bx bx-box'></i> My Products</a>
                <a href="/marketplace/products/create/"><i class='bx bx-plus'></i> Create Product</a>
                <a href="/marketplace/sales/"><i class='bx bx-bar-chart-alt-2'></i> Sales Dashboard</a>
                <div class="dropdown-divider"></div>
                <span class="dropdown-label">Communication</span>
                <a href="/marketplace/conversations/"><i class='bx bx-chat'></i> Messages</a>
              </div>
            </div>
          </div>
          
          <div class="nav-section">
            <span class="nav-label">System</span>
            
            <div class="dropdown">
              <button class="dropdown-toggle">
                <i class='bx bx-cog'></i> Settings
                <i class='bx bx-chevron-down'></i>
              </button>
              <div class="dropdown-menu">
                {% if user.is_organization %}
                  <a href="/users/organization/"><i class='bx bx-building'></i> Organization</a>
                  <div class="dropdown-divider"></div>
                  <span class="dropdown-label">Team</span>
                  <a href="/users/organization/members/"><i class='bx bx-group'></i> Members</a>
                  <a href="/users/organization/settings/"><i class='bx bx-cog'></i> Settings</a>
                {% else %}
                  {% with org=user.get_organization %}
                    {% if org %}
                      <a href="/users/organization/{{ org.id }}/"><i class='bx bx-building'></i> {{ org.organization_name }}</a>
                      {% if user.memberships.first.role in 'owner,admin' %}
                      <div class="dropdown-divider"></div>
                      <span class="dropdown-label">Team</span>
                      <a href="/users/organization/{{ org.id }}/members/"><i class='bx bx-group'></i> Members</a>
                      <a href="/users/organization/{{ org.id }}/settings/"><i class='bx bx-cog'></i> Settings</a>
                      {% endif %}
                    {% endif %}
                  {% endwith %}
                {% endif %}
                <div class="dropdown-divider"></div>
                <span class="dropdown-label">System</span>
                <a href="/marketplace/integrations/"><i class='bx bx-plug'></i> Integrations</a>
              </div>
            </div>
          </div>

          <div class="nav-section nav-user">
            {% if user.is_authenticated %}
              <div class="dropdown">
                <button class="dropdown-toggle user-toggle">
                  <i class='bx bxs-user-circle'></i>
                  <span>{{ user.username }}</span>
                </button>
                <div class="dropdown-menu">
                  <a href="/users/"><i class='bx bx-user'></i> User Dashboard</a>
                  {% if user.is_staff %}
                    <a href="/admin/"><i class='bx bx-shield'></i> Admin</a>
                  {% endif %}
                  <div class="dropdown-divider"></div>
                  <a href="/logout/"><i class='bx bx-log-out'></i> Logout</a>
                </div>
              </div>
            {% else %}
              <div class="nav-auth-buttons">
                <a href="/login/" class="nav-button login-button">
                  <i class='bx bx-log-in'></i>
                  <span>Login</span>
                </a>
                <a href="/signup/" class="nav-button signup-button">
                  <i class='bx bx-user-plus'></i>
                  <span>Sign Up</span>
                </a>
              </div>
            {% endif %}
          </div>
        </nav>
      </div>
    </header>

    <main class="container">
      <div class="breadcrumb">
        <a href="/">Home</a> {% block breadcrumb %}{% endblock %}
      </div>
      {% block content %}{% endblock %}
    </main>

    <footer>
      <div style="max-width:1100px;margin:0 auto">
        Icycon â€” Made with ðŸ’™ for efficiency
      </div>
    </footer>

    <!-- Quick Actions -->
    <div class="quick-actions" style="position:fixed;bottom:24px;right:24px;z-index:1000">
      <div style="display:flex;flex-direction:column;gap:8px">
        <button class="quick-action-btn scroll-top" title="Scroll to Top">
          <i class='bx bx-up-arrow'></i>
        </button>
        {% if user.is_authenticated %}
          {# Only show quick-create to staff or tenant members who are not read-only viewers #}
          {% with first_tenant=user.tenantuser_set.first %}
            {% if user.is_staff or first_tenant and first_tenant.role != 'viewer' %}
              <button class="quick-action-btn create-new" title="Quick Create">
                <i class='bx bx-plus'></i>
              </button>
            {% endif %}
          {% endwith %}
        {% endif %}
        <button class="quick-action-btn help" title="Help">
          <i class='bx bx-help-circle'></i>
        </button>
      </div>
    </div>

    <!-- Quick Create Menu -->
    <div id="quickCreateMenu" class="quick-menu" style="display:none;position:fixed;bottom:80px;right:80px;background:white;border-radius:8px;box-shadow:0 4px 12px var(--shadow);padding:8px 0;min-width:200px">
      <span class="dropdown-label">Content</span>
      <a href="/social-posts/create/article" class="quick-menu-item">
        <i class='bx bx-book-content'></i>
        <span>New Article</span>
      </a>
      <a href="/social-posts/create/news" class="quick-menu-item">
        <i class='bx bx-news'></i>
        <span>New News Update</span>
      </a>
      <a href="/social-posts/create/tutorial" class="quick-menu-item">
        <i class='bx bx-chalkboard'></i>
        <span>New Tutorial</span>
      </a>
      <div class="dropdown-divider"></div>
      <span class="dropdown-label">Marketing</span>
      <a href="/social-posts/create/social" class="quick-menu-item">
        <i class='bx bx-message-square-detail'></i>
        <span>New Social Post</span>
      </a>
      <a href="/seo-content-items/create/" class="quick-menu-item">
        <i class='bx bx-file'></i>
        <span>New SEO Content</span>
      </a>
      <div class="dropdown-divider"></div>
      <span class="dropdown-label">Other</span>
      <a href="/email-templates/create/" class="quick-menu-item">
        <i class='bx bx-envelope'></i>
        <span>New Email Template</span>
      </a>
    </div>

    <!-- Help Panel -->
    <div id="helpPanel" class="help-panel" style="display:none;position:fixed;top:0;right:0;bottom:0;width:320px;background:white;box-shadow:-2px 0 12px var(--shadow);padding:24px;overflow-y:auto">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px">
        <h3 style="margin:0">Help & Resources</h3>
        <button class="close-help" style="background:none;border:none;color:var(--text);cursor:pointer">
          <i class='bx bx-x'></i>
        </button>
      </div>
      <div class="help-content">
        <!-- Dynamically populated based on current page -->
      </div>
    </div>

    <style>
      .quick-action-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--primary);
        color: white;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        transition: transform 0.2s, background-color 0.2s;
        box-shadow: 0 2px 8px var(--shadow);
      }
      .quick-action-btn:hover {
        transform: scale(1.1);
        background: var(--primary-dark);
      }
      .quick-menu-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        color: var(--text);
        text-decoration: none;
        transition: background-color 0.2s;
      }
      .quick-menu-item:hover {
        background: var(--bg);
      }
      .help-panel {
        z-index: 1100;
      }
    </style>

    <script>
      // Mobile Menu Toggle
      document.querySelector('.mobile-menu-toggle').addEventListener('click', () => {
        document.querySelector('.main-nav').classList.toggle('active');
      });

      // Scroll to Top
      document.querySelector('.scroll-top').addEventListener('click', () => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });

      // Quick Create Menu
      const quickCreateBtn = document.querySelector('.create-new');
      const quickCreateMenu = document.getElementById('quickCreateMenu');
      if (quickCreateBtn) {
        quickCreateBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          quickCreateMenu.style.display = quickCreateMenu.style.display === 'none' ? 'block' : 'none';
        });
      }

      // Help Panel
      const helpBtn = document.querySelector('.help');
      const helpPanel = document.getElementById('helpPanel');
      const closeHelp = document.querySelector('.close-help');

      helpBtn.addEventListener('click', () => {
        helpPanel.style.display = 'block';
        fetch(`/api/help${window.location.pathname}`)
          .then(response => response.json())
          .then(data => {
            const helpContent = document.querySelector('.help-content');
            helpContent.innerHTML = `
              <div class="help-section">
                <h4>Quick Start</h4>
                <p>${data.quickStart || 'No quick start guide available.'}</p>
              </div>
              <div class="help-section">
                <h4>Features</h4>
                <ul>
                  ${(data.features || []).map(f => `<li>${f}</li>`).join('')}
                </ul>
              </div>
              <div class="help-section">
                <h4>Related Documentation</h4>
                <ul>
                  ${(data.docs || []).map(d => `<li><a href="${d.url}">${d.title}</a></li>`).join('')}
                </ul>
              </div>
            `;
          })
          .catch(() => {
            const helpContent = document.querySelector('.help-content');
            helpContent.innerHTML = '<p>Help content is not available for this page.</p>';
          });
      });

      closeHelp.addEventListener('click', () => {
        helpPanel.style.display = 'none';
      });

      // Click outside to close menus
      document.addEventListener('click', (e) => {
        if (quickCreateMenu && !quickCreateBtn.contains(e.target) && !quickCreateMenu.contains(e.target)) {
          quickCreateMenu.style.display = 'none';
        }
      });

      // Track recently visited pages
      const addRecentPage = () => {
        const currentPage = {
          title: document.title.split('â€”')[0].trim(),
          url: window.location.pathname,
          timestamp: Date.now()
        };
        
        let recentPages = JSON.parse(localStorage.getItem('recentPages') || '[]');
        recentPages = [currentPage, ...recentPages.filter(p => p.url !== currentPage.url)].slice(0, 5);
        localStorage.setItem('recentPages', JSON.stringify(recentPages));
      };

      addRecentPage();

      // Global CSRF token helper for forms and AJAX
      function getCSRFToken() {
        return document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
      }

      // Ensure all forms include CSRF token if not already present
      document.querySelectorAll('form').forEach(form => {
        if (form.method.toUpperCase() === 'POST' && !form.querySelector('[name="csrfmiddlewaretoken"]')) {
          const csrfInput = document.createElement('input');
          csrfInput.type = 'hidden';
          csrfInput.name = 'csrfmiddlewaretoken';
          csrfInput.value = getCSRFToken();
          form.appendChild(csrfInput);
        }
      });
    </script>

    <!-- Chatbot Widget - Appears on all pages for authenticated users -->
    <script src="{% static 'chatbot/chat.js' %}"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Initialize chatbot for authenticated users who belong to a tenant
        {% if user.is_authenticated and not user.is_staff and not user.is_superuser %}
          {% with first_tenant=user.tenantuser_set.first %}
            {% if first_tenant %}
              window.chatWidget = new ChatWidget({{ first_tenant.tenant.id }});
            {% endif %}
          {% endwith %}
        {% endif %}
      });
    </script>
  </body>
</html>